---
layout: post
title: [ASP.NET Web API]è‡ªå®šä¹‰çš„å®¿ä¸»ç¯å¢ƒä¸­ä½¿ç”¨å¤–éƒ¨ç¨‹ç‹¬ç«‹ Controller
category: net
description: è‡ªå®šä¹‰ WEB API å®¿ä¸»ç¨‹åºï¼Œå¦‚æœç”¨åˆ°å¤–éƒ¨çš„ Controller dllï¼Œéœ€è¦å°† dll æ˜ å°„åˆ°å½“å‰ç¨‹åºåŸŸã€‚æ“ä½œç®€å•ï¼Œè¿™ä¸ªè¿‡ç¨‹è•´å« ASP.NET WEB ä¸€æ•´å¥—é€»è¾‘ã€‚
keywords: ASP.NET,API,å®¿ä¸»ç¨‹åº,å¤–éƒ¨ç¨‹åºé›† 
---

###èƒŒæ™¯

æœ€è¿‘æ‰“ç®—å¯¹ä¸€ä¸ª **Web API** é¡¹ç›®åšä»£ç æ··æ·†ï¼Œä½†ç”±äºå®¿ä¸»ç¯å¢ƒæ˜¯ `IIS`,å¯¼è‡´å®Œå…¨æ··æ·†åï¼Œ IIS ä¸èƒ½å¾ˆå¥½çš„è§£æã€‚äºæ˜¯å†³å®šè‡ªå·±å†™ä¸€ä¸ªå®¿ä¸»ç¯å¢ƒã€‚

ç”¨ä¸€ä¸ªæ§åˆ¶å°é¡¹ç›®ï¼Œç”¨ä¸€æ®µç®€å•çš„ä»£ç 

```
 static void Main(string[] args)
        {
            var config = new HttpSelfHostConfiguration("http://127.0.0.1:3333");
            config.Routes.MapHttpRoute("default", "api/{controller}/{id}", new { id = RouteParameter.Optional });
            var server = new HttpSelfHostServer(config);
            server.OpenAsync().Wait();
            
            Console.WriteLine("Server is opened");
            Console.Read();
        }

```

å°†å¤–éƒ¨çš„ `Controller dll` ä»¥åŠç›¸å…³çš„ **dll** å¼•å…¥åˆ°å½“å‰çš„ç¨‹åºä¸‹ã€‚æ‰“å¼€æµè§ˆå™¨è¯·æ±‚ã€‚

å‡ºç°ä»¥ä¸‹é”™è¯¯

```
<Error>
<Message>
æœªæ‰¾åˆ°ä¸è¯·æ±‚ URIâ€œhttp://127.0.0.1:3333/api/Product/Valuesâ€åŒ¹é…çš„ HTTP èµ„æºã€‚
</Message>
<MessageDetail>æœªæ‰¾åˆ°ä¸åä¸ºâ€œProductâ€çš„æ§åˆ¶å™¨åŒ¹é…çš„ç±»å‹ã€‚</MessageDetail>
</Error>

```

ç»åˆ†æå¯¼è‡´é”™è¯¯çš„åŸå› æ˜¯ï¼šé»˜è®¤æ³¨å†Œçš„ `DefaultAssembliesResolver` ä»…ä»…æä¾›å½“å‰åº”ç”¨ç¨‹åºåŸŸåŠ è½½çš„ç¨‹åºé›†ã€‚æˆ‘å¼•å…¥çš„ç¨‹åºé›†å¹¶æ²¡æœ‰åŠ è½½åœ¨å½“å‰ç¨‹åºåŸŸä¸­ã€‚

äºæ˜¯å…ˆç»§æ‰¿ `DefaultAssembliesResolver` å°†ç‹¬ç«‹çš„ **dll** æ·»åŠ åˆ°å½“å‰ç¨‹åºåŸŸä¸­ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```
public class CustomAssembliesResolver : DefaultAssembliesResolver
    {
        public override ICollection<Assembly> GetAssemblies()
        {
            ICollection<Assembly> baseAssemblies = base.GetAssemblies();

            List<Assembly> assemblies = new List<Assembly>(baseAssemblies);

            var controllersAssembly = Assembly.LoadFrom(@"TestHostApi.dll");

            baseAssemblies.Add(controllersAssembly);

            return baseAssemblies;
        }
    }

```

å¯¹å®¿ä¸»ç¨‹åºåšä¸€å°ç‚¹ä¿®æ”¹ä¸ºï¼š

```
            var config = new HttpSelfHostConfiguration("http://127.0.0.1:3333");
            config.Routes.MapHttpRoute("default", "api/{controller}/{id}", new { id = RouteParameter.Optional });
            var server = new HttpSelfHostServer(config);

            CustomAssembliesResolver assemblyResolver = new CustomAssembliesResolver();
            server.Configuration.Services.Replace(typeof(IAssembliesResolver), new ExtendedDefaultAssembliesResolver());

            server.OpenAsync().Wait();
            
            Console.WriteLine("Server is opened");
            Console.Read();
```

è¿™æ ·å†æ¬¡æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼Œå¾—åˆ°äº†æˆ‘æƒ³è¦çš„ç»“æœã€‚

###è¿½æº¯

é—®é¢˜è§£å†³äº†ï¼Œä½† `HttpSelfHostServer` åˆ°åº•æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä¸å¦¨è¿½æ ¹å¯»æºï¼Œæ¢ç©¶ä»¥å®ƒæœ¬åçš„é€»è¾‘ã€‚

ç»§æ‰¿ä½“ç³»

```

â”œâ”€System.Object 
â”‚  â”œâ”€HttpMessageHandler
â”‚     â””â”€DelegatingHandler
â”‚       â””â”€System.Web.Http.HttpServer
            â””â”€System.Web.Http.SelfHost.HttpSelfHostServer

```
####HttpMessageHandler

**ASP.NET Web** æ ¸å¿ƒæ¡†æ¶æ˜¯åŸºäºæ¶ˆæ¯çš„ç®¡é“ã€‚æ‰€æœ‰çš„æ¶ˆæ¯éƒ½ç»è¿‡ `HttpMessageHandler` å¤„ç†ï¼Œè¿™ä¸ªç‹¬ç«‹çš„æŠ½è±¡ç®¡é“ç‹¬ç«‹äºå¯„å®¿ç¯å¢ƒã€‚

ä»£ç ï¼š

```
 public abstract class HttpMessageHandler : IDisposable
    {
       public void Dispose();
       protected virtual void Dispose(bool disposing);
       protected abstract Task<HttpResponseMessage> SendAsync(HttpRequestMessage request, CancellationToken cancellationToken);
   }

```

####DelegatingHandler

**ASP.NET Web API** æ¶ˆæ¯å¤„ç†ç®¡é“æ˜¯é€šè¿‡ä¸€ç»„æœ‰åºçš„ `HttpMessagHandler` ã€é¦–å°¾ç›¸è¿ã€è€Œæˆï¼Œå…·ä½“å®ç°æ˜¯é€šè¿‡ `DelegatingHandler` è¿™ä¸ªç±»å‹æ¥å®Œæˆçš„ã€‚

ä»£ç ï¼š

```
public abstract class DelegatingHandler : HttpMessageHandler
    {  
        protected internal override Task<HttpResponseMessage> SendAsync(HttpRequestMessage request, CancellationToken cancellationToken);
        public HttpMessageHandler InnerHandler get;  set; }
    }

```

`DelegatingHandler`  æ ¹æ®å…¶ `InnerHandler` è·å¾—è¢«å§”æ‰˜çš„ `HttpMessageHandler` å¯¹è±¡çš„å¼•ç”¨,å¯¹æ¶ˆæ¯å¤„ç†ã€‚

####HttpServer

`HttpServer` ç›´æ¥ç»§æ‰¿è‡ª `DelegatingHandler`ã€‚å®ƒæœ‰ä¸¤ä¸ªé‡è¦çš„åªè¯»å±æ€§ï¼ˆ`Configuration` å’Œ `Dispatcher`ï¼‰ï¼Œå‰è€…å¾—åˆ°ç”¨äºé…ç½®æ•´ä¸ªæ¶ˆæ¯å¤„ç†ç®¡é“çš„ `HttpConfiguration` å¯¹è±¡ï¼Œå¦å¤–ä¸€ä¸ªå±æ€§`Dispatcher` è¿”å›çš„æ˜¯å¤„äºæ•´ä¸ªæ¶ˆæ¯å¤„ç†ç®¡é“ã€å°¾ç«¯ã€çš„`HttpMessageHandler`ã€‚

ä»£ç ï¼š

```
    public class HttpServer : DelegatingHandler
    {
          public HttpConfiguration     Configuration { get; }
          public HttpMessageHandler    Dispatcher { get; }
     
          public HttpServer();
          public HttpServer(HttpMessageHandler dispatcher);
          public HttpServer(HttpConfiguration configuration);
          public HttpServer(HttpConfiguration configuration, HttpMessageHandler dispatcher);
    
          protected override void Dispose(bool disposing);   
          protected virtual void Initialize();  
          protected override Task<HttpResponseMessage> SendAsync(HttpRequestMessage request, CancellationToken cancellationToken);
    }

```

`HttpServer` çš„ `Configuration` å’Œ `Dispatcher` å±æ€§å‡å¯ä»¥åœ¨ç›¸åº”çš„æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–ã€‚å¦‚æœåœ¨æ„é€ `HttpServer` çš„æ—¶å€™æ²¡æœ‰æ˜¾å¼æŒ‡å®šè¿™ä¸¤ä¸ªå±æ€§çš„å€¼ï¼ˆè°ƒç”¨é»˜è®¤çš„æ— å‚æ„é€ å‡½æ•°åˆ›å»º `HttpServer`ï¼‰ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ä¼šåˆ›å»ºä¸€ä¸ª`HttpConfiguration`ä½œä¸º`Configuration`çš„å±æ€§å€¼ï¼Œè€Œä½œä¸º`Dispatcher`å±æ€§å€¼çš„åˆ™æ˜¯ä¸€ä¸ª`HttpRoutingDispatcher`å¯¹è±¡ï¼Œè¯¥ç±»å‹å®šä¹‰åœ¨å‘½åç©ºé—´`System.Web.Http.Dispatcher`ä¸‹ã€‚

æ•´ä¸ªç®¡é“éƒ½æ˜¯ç”±`HttpConfiguration` è¿›è¡Œé…ç½®ï¼š

#####HttpConfiguration

ä»£ç 

```

public class HttpConfiguration : IDisposable
    {
        public HttpConfiguration();
        public HttpConfiguration(HttpRouteCollection routes);
        // è·å–æˆ–è®¾ç½®ä¸æ­¤å®ä¾‹å…³è”çš„ä¾èµ–å…³ç³»è§£æç¨‹åºã€‚
        //è¿”å›ç»“æœ:ä¾èµ–å…³ç³»è§£æç¨‹åºã€‚
        public IDependencyResolver DependencyResolver { get; set; }
        //ç­›é€‰å™¨åˆ—è¡¨ã€‚
        public HttpFilterCollection Filters { get; }
        public MediaTypeFormatterCollection Formatters { get; }
        public IncludeErrorDetailPolicy IncludeErrorDetailPolicy { get; set; }
        public Action<HttpConfiguration> Initializer { get; set; }
        public Collection<DelegatingHandler> MessageHandlers { get; }
        public ParameterBindingRulesCollection ParameterBindingRules { get; internal set; }
        public ConcurrentDictionary<object, object> Properties { get; }
        public HttpRouteCollection Routes { get; }    
        //è·å–ä¸æ­¤å®ä¾‹å…³è”çš„é»˜è®¤æœåŠ¡çš„å®¹å™¨ã€‚
        // è¿”å›ç»“æœ: 
        // åŒ…å«æ­¤å®ä¾‹çš„é»˜è®¤æœåŠ¡çš„ System.Web.Http.Controllers.ServicesContainerã€‚
        public ServicesContainer Services { get; internal set; }
        public string VirtualPathRoot { get; }
        public void Dispose();
        protected virtual void Dispose(bool disposing);
    }

```

å…¶ä¸­å±æ€§ `DependencyResolver`  å’Œ `Services`  æä¾›äº†å¾ˆå¤§çš„çµæ´»æ€§ã€‚

####HttpSelfHostServer

`HttpSelfHostServer` æ˜¯ä¸€ä¸ªå¯†å°ç±»ï¼Œç»§æ‰¿è‡ª`HttpServer`ã€‚å®ƒçš„æ„é€ ä¸­ç”¨äº† `Configuration`çš„æ´¾ç”Ÿç±»(`HttpSelfHostConfiguration`)ï¼Œå¹¶æä¾›ç›‘å¬çš„æ‰“å¼€å’Œå…³é—­æ–¹æ³•ã€‚

ä»£ç ï¼š

```
 //ç›´æ¥ä¾¦å¬ HTTP çš„ System.Web.Http.HttpServer çš„å®ç°ã€‚
    public sealed class HttpSelfHostServer : HttpServer
    {

        public HttpSelfHostServer(HttpSelfHostConfiguration configuration);
      
        // configuration: é…ç½®ã€‚
        // dispatcher:è°ƒåº¦ç¨‹åºã€‚
        public HttpSelfHostServer(HttpSelfHostConfiguration configuration, HttpMessageHandler dispatcher);
        
        // ä¸€ä¸ªè¡¨ç¤ºå¼‚æ­¥ System.Web.Http.HttpServer å…³é—­æ“ä½œçš„ System.Threading.Tasks.Taskã€‚
        public Task CloseAsync();
        protected override void Dispose(bool disposing);
        
        // è¿”å›ç»“æœ: 
        // ä¸€ä¸ªè¡¨ç¤ºå¼‚æ­¥ System.Web.Http.HttpServer æ‰“å¼€æ“ä½œçš„ System.Threading.Tasks.Taskã€‚ä¸€æ—¦æˆåŠŸå®Œæˆæ­¤ä»»åŠ¡ï¼ŒæœåŠ¡å™¨å°†è¿è¡Œã€‚
        public Task OpenAsync();
    }

```
`HttpSelfHostConfiguration` ç»§æ‰¿è‡ª `HttpConfiguration` ï¼Œæœ‰ä¸€ä¸ª `ServicesContainer` ç±»å‹çš„å±æ€§`Services`,æ­¤å±æ€§æœ‰å¤§ç”¨â€¼ï¸

####ServicesContainer

ä½“ç³»ç»“æ„

```
System.Object
â””â”€System.Web.Http.Controllers.ServicesContainer
    â””â”€System.Web.Http.Controllers.ControllerServices
        â””â”€System.Web.Http.Services.DefaultServices
```

`ServicesContainer` ç”¨äºæœåŠ¡ç®¡ç†ï¼Œæœ‰æ·»åŠ ä¿®æ”¹å’Œåˆ é™¤ç­‰æ“ä½œæ–¹æ³•ã€‚

####IAssembliesResolver

åœ¨ **ASP.NET Web API** çš„ `HttpController` æ¿€æ´»ç³»ç»Ÿä¸­ï¼Œ`AssembliesResolver` ä¸ºç›®æ ‡ `HttpController` ç±»å‹è§£ææä¾›å€™é€‰çš„ç¨‹åºé›†ã€‚è¯¥æ¥å£å®šä¹‰åœ¨å‘½åç©ºé—´ `System.Web.Http.Dispatcher` ä¸‹ã€‚

å®šä¹‰ï¼š

```
  public interface IAssembliesResolver
   {
       ICollection<Assembly> GetAssemblies();
   }

```

åœ¨ **ASP.NET Web API** æœ‰ä¸€ä¸ªé‡è¦çš„ç±» `DefaultAssembliesResolver` ç»§æ‰¿äº† `IAssembliesResolver`

```
    public class DefaultAssembliesResolver : IAssembliesResolver
    {
        public virtual ICollection<Assembly> GetAssemblies()
        {
            return AppDomain.CurrentDomain.GetAssemblies().ToList<Assembly>();
        }
    }

```

ä»`DefaultAssembliesResolver` çš„å®ç°ä¸Šå¯ä»¥çœ‹åˆ°é»˜è®¤çš„æ³¨å°„å™¨åªèƒ½æ³¨å°„å½“å‰ç¨‹åºåŸŸçš„ç¨‹åºé›†ã€‚

###æ€»ç»“

åˆ†æåˆ°è¿™é‡Œï¼Œç»ˆäºäº†ç„¶äº†ï¼Œè‡ªå®šä½çš„å®¿ä¸»ç¨‹åºä¸­è¦å¼•å…¥å¤–éƒ¨çš„ **Controller**ï¼Œå¿…é¡»é‡æ–°å®ç° **IAssembliesResolver**ï¼Œæˆ–è€…ç»§æ‰¿ `DefaultAssembliesResolver`é‡å†™ **GetAssemblies()**æ–¹æ³•ã€‚

**ASP.NET Web** æ˜¯ä¸€ä¸ªä¸¥è°¨è€Œå…·æœ‰é«˜æ‰©å±•æ€§çš„æ¡†æ¶ï¼Œ`HttpSelfHostServer`æ˜¯åŸºäºè¿™ä¸ªæ¡†æ¶å®ç°ï¼Œè¦å®ç°ä¸€ä¸ªå®Œå–„çš„å®¿ä¸»ç¨‹åºï¼Œå¿…é¡»å¯¹è¿™ä¸ªæœºåˆ¶æœ‰ä¸€å®šçš„äº†è§£ï¼Œåˆ©ç”¨è¯¥ã€ç»„ç»‡ã€æä¾›çš„æœåŠ¡å’Œåè®®ï¼Œç«™åœ¨å·¨äººè‚©è†€ä¸Šï¼Œæ‰èƒ½å‘ç°ã€ä¸‡æœ‰å¼•åŠ›ã€ğŸ˜„ï¼
